{% extends 'base.html' %}
{% load staticfiles %}
{% load i18n %}
{% block title %}登录{% endblock %}

{% block css %}

{% endblock %}

{% block content %}
    {% if not user.username %}
        <div class="jumbotron col-md-8 col-md-offset-2">
            <img src = '{% static 'img/account_filler.jpg' %}' class="col-md-5 img-responsive">
            <form action="../" method="post" id="login" class="form-horizontal col-md-4 col-md-offset-1">
                {% csrf_token %}
                <div class="form-group">
                    {{ form.username }}
                </div>
                <div class="form-group">
                    <div class="text-left">{{ form.password }}</div>
                </div>
                <div class="form-group text-center">
                    <div id="success_message"></div>
                    <div id="warning_message"></div>
                    <div id="error_message"></div>
                </div>
                <div class="form-group text-center">
                    <p style="margin-top: 10px;">{% trans '忘记密码?' %}<a href="#">{% trans '重置' %}</a></p>
                    <p style="margin-top: 10px;">{% trans '如果您还没有账号,点击' %}<a href="{% url 'register' %}">{% trans '注册' %}</a></p>
                </div>
                <div class="text-center">
                    <a class="btn btn-default btn-lg" id="login_submit">登录</a>
                </div>
            </form>
        </div>
    {% else %}
        <div class="jumbotron col-md-8 col-md-offset-2">
            <h3>您已登录！点击<a href="{% url 'logout' %}">登出</a></h3>
            <a class="btn btn-primary btn-lg" id="back">返回</a>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
    <script>
        $(function () {
            $("#back").click(function () {
                window.location.href='{{ next }}'
            });

            $("#id_username").attr({'placeholder':"用户名"});
            $("#id_password").attr({'placeholder':"密码"});

            var csrftoken = $("[name=csrfmiddlewaretoken]").val();
            $("#login_submit").click(function () {
                $("#error_message").text('');
                $.ajax({
                    url:{% url 'login' %},
                    type: "post",
                    data: {
                        "username": $("#id_username").val(),
                        "password": $("#id_password").val(),
                        "csrfmiddlewaretoken": csrftoken
                    },
                    success: function (e) {
                        if (e.code === 0) {
                            $("#success_message").text('登陆成功！');
                            setTimeout(function () {
                                window.location.href = '{{ next }}';
                            }, 1000);
                        }
                        else {
                            $("#error_message").text(e.message)
                        }
                    },
                })
            });
        })
    </script>
{% endblock %}
