<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hit.to.go.database.dao.ApplyMapper">
    <resultMap id="baseResultMap" type="apply">
        <id column="apply_id" property="id" />
        <result column="apply_user_id" property="userId" />
        <result column="apply_time" property="time" />
        <result column="apply_note" property="note" />
        <result column="apply_state" property="state" />
        <result column="apply_handler_time" property="handleTime" />
        <result column="apply_handle_note" property="handleNote" />

        <association property="handler" javaType="User">
            <id column="user_id" jdbcType="INTEGER" property="id" />
            <result column="user_name" jdbcType="VARCHAR" property="name" />
            <result column="user_type" jdbcType="INTEGER" property="type" />
            <result column="user_sex" jdbcType="VARCHAR" property="sex" />
            <result column="birthday" jdbcType="DATE" property="birthday" />
            <result column="user_email" jdbcType="VARCHAR" property="email" />
            <result column="user_education" jdbcType="VARCHAR" property="education" />
            <result column="user_intro" jdbcType="VARCHAR" property="intro" />
            <result column="note" jdbcType="VARCHAR" property="note" />
            <result column="user_phone" jdbcType="VARCHAR" property="phone" />
            <result column="img" jdbcType="VARCHAR" property="img" />

            <association property="school" javaType="School">
                <id column="school_id" property="id"/>
                <result column="school_name" property="name" />
                <result column="school_code" property="code" />
                <result column="school_depart" property="depart" />
                <result column="school_location" property="location" />
                <result column="school_level" property="level" />
                <result column="school_type" property="type" />
            </association>
        </association>
    </resultMap>


    <insert id="applyTeacher" parameterType="Map" keyProperty="apply_id" useGeneratedKeys="true">
        insert into apply
        (apply_user_id, apply_time, apply_note)
        VALUES
        (#{userId}, #{time}, #{note, jdbcType=VARCHAR})
    </insert>

    <insert id="applyToBeTeacher" parameterType="Map" keyProperty="apply_id" useGeneratedKeys="true">
        insert into apply
        (apply_user_id, apply_time, apply_note)
        select #{userId}, #{time}, #{note, jdbcType=VARCHAR}
        from DUAL where not exists (select * from apply where apply_user_id = #{userId} and apply_state = 1)
    </insert>

    <update id="acceptApply" parameterType="Map">
        update apply, user set
        apply.apply_handler_id = #{handlerId},
        apply.apply_handler_time = #{handleTime},
        apply.apply_state = 2,
        apply.apply_handle_note = #{note, jdbcType=VARCHAR},
        user.user_type = 3
        where apply_id = #{applyId} and apply.apply_user_id = user.user_id and apply_state = 1
    </update>

    <update id="rejectApply" parameterType="Map">
        update apply set
        apply_state = 3,
        apply_handler_time = #{handleTime},
        apply_handler_id = #{handlerId},
        apply_handle_note = #{note, jdbcType=VARCHAR}
        where apply_id = #{applyId} and apply_state = 1
    </update>

    <select id="getAllApplies" parameterType="Map" resultMap="baseResultMap">
        select  apply.*, user.*, school.* from
        apply left join user on apply.apply_handler_id = user.user_id
        left join school on user.user_school = school.school_id
        where 1 = 1
        <if test="power != 2">
            and apply_user_id = #{id}
        </if>
    </select>

    <select id="getAllUnhandledApplies" parameterType="Map" resultMap="baseResultMap">
        select  apply.*, user.*, school.* from
        apply left join user on apply.apply_handler_id = user.user_id
        left join school on user.user_school = school.school_id
        where apply_state = 1
        <if test="power != 2">
            and apply_user_id = #{id}
        </if>
    </select>

    <select id="getAllHandledApplies" parameterType="Map" resultMap="baseResultMap">
        select apply.*, user.*, school.* from
        apply left join user on apply.apply_handler_id = user.user_id
        left join school on user.user_school = school.school_id
        where (apply_state = 2 or apply_state = 3)
        <if test="power != 2">
            and apply_user_id = #{id}
        </if>
    </select>
</mapper>
